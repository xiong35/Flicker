# 1. 系统实现

## 1.1. 运行环境

计算机环境: 使用的是 windows10 进行的开发。
处理器: Intel（R）Core（TM）i7-8750H @ 2.20Ghz 2.21Ghz
内存（RAM）: 16.0GB（15.9GB 可用）
系统类型: 64 位操作系统，基于 x64 的处理器
编程语言: 前端：NodeJS 14.18.1，后端：golang 17.2
程序框架: 前端: React，后端: Echo，数据库：MongoDB、Redis
IDE: VSCode、Goland

## 1.2. 前端关键模块说明

TODO

## 1.3. 后端关键模块说明

由于本项目工程量极大，无法详尽描述所有核心函数的实现。并且本项目提供了详细的API文档，同时拥有较为简明直观的注释，此处将关键模块与函数导出。由于本项目约定的开发标准，所有注释使用英文。详细描述见API文档。

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

```go
import "github.com/woolen-sheep/Flicker-BE"
```

#### Index

- [func main()](<#func-main>)


#### func main

```go
func main()
```

程序入口，负责初始化echo框架，并且调用路由初始化函数。

### router（路由模块）

```go
import "github.com/woolen-sheep/Flicker-BE/router"
```

#### Index

- [func InitRouter(g *echo.Group)](<#func-initrouter>)
- [func initCardRouter(g *echo.Group)](<#func-initcardrouter>)
- [func initCardsetRouter(g *echo.Group)](<#func-initcardsetrouter>)
- [func initIndexRouter(g *echo.Group)](<#func-initindexrouter>)
- [func initRecordRouter(g *echo.Group)](<#func-initrecordrouter>)
- [func initServiceRouter(g *echo.Group)](<#func-initservicerouter>)
- [func initUserRouter(g *echo.Group)](<#func-inituserrouter>)


#### func InitRouter

```go
func InitRouter(g *echo.Group)
```

InitRouter will initialize all routers

#### func initCardRouter

```go
func initCardRouter(g *echo.Group)
```

初始化卡片API路由

#### func initCardsetRouter

```go
func initCardsetRouter(g *echo.Group)
```

初始化卡片集API路由

#### func initIndexRouter

```go
func initIndexRouter(g *echo.Group)
```

初始化根路由

#### func initRecordRouter

```go
func initRecordRouter(g *echo.Group)
```

初始化学习记录API路由

#### func initServiceRouter

```go
func initServiceRouter(g *echo.Group)
```

初始化第三方服务API路由，主要为七牛云存储

#### func initUserRouter

```go
func initUserRouter(g *echo.Group)
```

初始化用户API路由

### controller（控制模块）

```go
import "github.com/woolen-sheep/Flicker-BE/controller"
```

#### Index

- [func ClearRecords(c echo.Context) error](<#func-clearrecords>)
- [func DeleteCard(c echo.Context) error](<#func-deletecard>)
- [func DeleteCardset(c echo.Context) error](<#func-deletecardset>)
- [func DeleteComment(c echo.Context) error](<#func-deletecomment>)
- [func GetCard(c echo.Context) error](<#func-getcard>)
- [func GetCards(c echo.Context) error](<#func-getcards>)
- [func GetCardset(c echo.Context) error](<#func-getcardset>)
- [func GetComments(c echo.Context) error](<#func-getcomments>)
- [func GetCreated(c echo.Context) error](<#func-getcreated>)
- [func GetFavorite(c echo.Context) error](<#func-getfavorite>)
- [func GetQiniuUploadToken(c echo.Context) error](<#func-getqiniuuploadtoken>)
- [func GetRandomCardsets(c echo.Context) error](<#func-getrandomcardsets>)
- [func GetRecords(c echo.Context) error](<#func-getrecords>)
- [func GetUser(c echo.Context) error](<#func-getuser>)
- [func HTTPErrorHandler(err error, c echo.Context)](<#func-httperrorhandler>)
- [func Login(c echo.Context) error](<#func-login>)
- [func NewCard(c echo.Context) error](<#func-newcard>)
- [func NewCards(c echo.Context) error](<#func-newcards>)
- [func NewCardset(c echo.Context) error](<#func-newcardset>)
- [func NewComment(c echo.Context) error](<#func-newcomment>)
- [func SearchCardsets(c echo.Context) error](<#func-searchcardsets>)
- [func SendVerifyCode(c echo.Context) error](<#func-sendverifycode>)
- [func SignUp(c echo.Context) error](<#func-signup>)
- [func UpdateCard(c echo.Context) error](<#func-updatecard>)
- [func UpdateCardset(c echo.Context) error](<#func-updatecardset>)
- [func UpdateFavorite(c echo.Context) error](<#func-updatefavorite>)
- [func UpdateLikedComment(c echo.Context) error](<#func-updatelikedcomment>)
- [func UpdateRecord(c echo.Context) error](<#func-updaterecord>)
- [func UpdateUser(c echo.Context) error](<#func-updateuser>)
- [func isCardsetAccessible(cardset, user string) bool](<#func-iscardsetaccessible>)
- [func isCardsetOwner(cardset, owner string) bool](<#func-iscardsetowner>)
- [func isCommentOwner(comment, owner string) bool](<#func-iscommentowner>)


#### func ClearRecords

```go
func ClearRecords(c echo.Context) error
```

#### func DeleteCard

```go
func DeleteCard(c echo.Context) error
```

DeleteCard will accept card ID and delete the exact card\.

#### func DeleteCardset

```go
func DeleteCardset(c echo.Context) error
```

DeleteCardset will accept cardset ID and delete the exact cardset\.

#### func DeleteComment

```go
func DeleteComment(c echo.Context) error
```

DeleteComment will accept card ID & comment ID and delete the exact comment\.

#### func GetCard

```go
func GetCard(c echo.Context) error
```

GetCard will accept card ID and return card info\.

#### func GetCards

```go
func GetCards(c echo.Context) error
```

GetCards will accept a card ID list and return a card info list\.

#### func GetCardset

```go
func GetCardset(c echo.Context) error
```

GetCardset will accept cardset ID and return cardset info\.

#### func GetComments

```go
func GetComments(c echo.Context) error
```

GetComments will accept card ID and return comments of the certain card\.

#### func GetCreated

```go
func GetCreated(c echo.Context) error
```

GetCreated will return cardsets created by current user\.

#### func GetFavorite

```go
func GetFavorite(c echo.Context) error
```

GetFavorite will return favorite cardsets of current user\.

#### func GetQiniuUploadToken

```go
func GetQiniuUploadToken(c echo.Context) error
```

#### func GetRandomCardsets

```go
func GetRandomCardsets(c echo.Context) error
```

GetRandomCardsets will return a list of random public cardsets\.

#### func GetRecords

```go
func GetRecords(c echo.Context) error
```

GetRecords will accept cardset ID and return all study record of current user\.

#### func GetUser

```go
func GetUser(c echo.Context) error
```

GetUser will accept user ID and return user info\. If param \`user\_id\` is empty\, will try to use user ID in JWT\.

#### func HTTPErrorHandler

```go
func HTTPErrorHandler(err error, c echo.Context)
```

HTTPErrorHandler will handle all errors and convert errors to certain format

#### func Login

```go
func Login(c echo.Context) error
```

Login will check password and return a JWT token\.

#### func NewCard

```go
func NewCard(c echo.Context) error
```

NewCard will add a new card\.

#### func NewCards

```go
func NewCards(c echo.Context) error
```

NewCards will add new cards\.

#### func NewCardset

```go
func NewCardset(c echo.Context) error
```

NewCardset will add a new cardset\.

#### func NewComment

```go
func NewComment(c echo.Context) error
```

NewComment will append a comment to a certain card\.

#### func SearchCardsets

```go
func SearchCardsets(c echo.Context) error
```

SearchCardsets will accept query param \`keyword\` and search in title and description of cardsets and return a cardset array\.

#### func SendVerifyCode

```go
func SendVerifyCode(c echo.Context) error
```

SendVerifyCode will shed a verify code to the given email address\. Two emails to the same address SHOULD have a duration of one minute at least\. Verify code will have a expire duration of 15 minutes\.

#### func SignUp

```go
func SignUp(c echo.Context) error
```

SignUp will check mail verify code and add a new user\.

#### func UpdateCard

```go
func UpdateCard(c echo.Context) error
```

UpdateCard will update card info of current card\. Empty fields will be ignored\.

#### func UpdateCardset

```go
func UpdateCardset(c echo.Context) error
```

UpdateCardset will update cardset info of current cardset\. Empty fields will be ignored\.

#### func UpdateFavorite

```go
func UpdateFavorite(c echo.Context) error
```

UpdateFavorite will add a cardset into current user collection

#### func UpdateLikedComment

```go
func UpdateLikedComment(c echo.Context) error
```

#### func UpdateRecord

```go
func UpdateRecord(c echo.Context) error
```

UpdateRecord will accept card ID and update study record

#### func UpdateUser

```go
func UpdateUser(c echo.Context) error
```

UpdateUser will update user info of current user\. Empty fields will be ignored\.

#### func isCardsetAccessible

```go
func isCardsetAccessible(cardset, user string) bool
```

#### func isCardsetOwner

```go
func isCardsetOwner(cardset, owner string) bool
```

#### func isCommentOwner

```go
func isCommentOwner(comment, owner string) bool
```

### model（数据库交互模块）

```go
import "github.com/woolen-sheep/Flicker-BE/model"
```

#### Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [func AddQiniuUploadRecord(key string, upload QiniuUpload) error](<#func-addqiniuuploadrecord>)
- [func GetMongoGlobalClient() *mongo.Client](<#func-getmongoglobalclient>)
- [func blockPrefix(p string) string](<#func-blockprefix>)
- [func configPrefix(p string) string](<#func-configprefix>)
- [func init()](<#func-init>)
- [func session(ctx context.Context, f func(ctx mongo.SessionContext) error) error](<#func-session>)
- [type Card](<#type-card>)
- [type CardInterface](<#type-cardinterface>)
- [type Cardset](<#type-cardset>)
- [type CardsetInterface](<#type-cardsetinterface>)
- [type Comment](<#type-comment>)
- [type CommentInterface](<#type-commentinterface>)
- [type Model](<#type-model>)
  - [func GetModel() Model](<#func-getmodel>)
- [type QiniuUpload](<#type-qiniuupload>)
- [type Record](<#type-record>)
- [type RecordInterface](<#type-recordinterface>)
- [type User](<#type-user>)
- [type UserInterface](<#type-userinterface>)
- [type dbTrait](<#type-dbtrait>)
  - [func getDBTx(ctx context.Context) dbTrait](<#func-getdbtx>)
- [type model](<#type-model>)
  - [func (m *model) Abort()](<#func-model-abort>)
  - [func (m *model) AddCard(card Card) (string, error)](<#func-model-addcard>)
  - [func (m *model) AddCards(card []Card) ([]string, error)](<#func-model-addcards>)
  - [func (m *model) AddCardset(cardset Cardset) (string, error)](<#func-model-addcardset>)
  - [func (m *model) AddComment(comment Comment) (string, error)](<#func-model-addcomment>)
  - [func (m *model) AddUser(user User) (string, error)](<#func-model-adduser>)
  - [func (m *model) ClearRecords(cardsetID, ownerID primitive.ObjectID) error](<#func-model-clearrecords>)
  - [func (m *model) Close()](<#func-model-close>)
  - [func (m *model) DeleteCard(card Card) (bool, error)](<#func-model-deletecard>)
  - [func (m *model) DeleteCardset(cardset Cardset) (bool, error)](<#func-model-deletecardset>)
  - [func (m *model) DeleteComment(comment Comment) (bool, error)](<#func-model-deletecomment>)
  - [func (m *model) GetCard(id string) (Card, bool, error)](<#func-model-getcard>)
  - [func (m *model) GetCardByIDList(ids []primitive.ObjectID) ([]Card, error)](<#func-model-getcardbyidlist>)
  - [func (m *model) GetCardInCardset(cardset string) ([]Card, error)](<#func-model-getcardincardset>)
  - [func (m *model) GetCardset(id string) (Cardset, bool, error)](<#func-model-getcardset>)
  - [func (m *model) GetCardsetByIDList(ids []primitive.ObjectID) ([]Cardset, error)](<#func-model-getcardsetbyidlist>)
  - [func (m *model) GetCardsetByKeyword(keyword string, skip, limit int) ([]Cardset, error)](<#func-model-getcardsetbykeyword>)
  - [func (m *model) GetCardsetByOwner(owner string) ([]Cardset, error)](<#func-model-getcardsetbyowner>)
  - [func (m *model) GetCardsetWithOwner(id, owner string) (Cardset, error)](<#func-model-getcardsetwithowner>)
  - [func (m *model) GetCommentWithOwner(commentID, owner string) (Comment, error)](<#func-model-getcommentwithowner>)
  - [func (m *model) GetComments(cardID string) ([]Comment, bool, error)](<#func-model-getcomments>)
  - [func (m *model) GetCount(cardset string) (int, error)](<#func-model-getcount>)
  - [func (m *model) GetLastStudyTime(cardsetID, ownerID primitive.ObjectID) int64](<#func-model-getlaststudytime>)
  - [func (m *model) GetRandomCardset(count int) ([]Cardset, error)](<#func-model-getrandomcardset>)
  - [func (m *model) GetRecord(cardsetID, cardID, ownerID primitive.ObjectID) (Record, error)](<#func-model-getrecord>)
  - [func (m *model) GetRecords(cardsetID, ownerID primitive.ObjectID) ([]Record, error)](<#func-model-getrecords>)
  - [func (m *model) GetUser(id string) (User, bool, error)](<#func-model-getuser>)
  - [func (m *model) GetUserByMail(mail string) (user User, err error)](<#func-model-getuserbymail>)
  - [func (m *model) GetVerifyCode(mail string) (string, error)](<#func-model-getverifycode>)
  - [func (m *model) IsCommentsLiked(card, user string) ([]bool, error)](<#func-model-iscommentsliked>)
  - [func (m *model) IsUserFavorite(user string, cardsetID primitive.ObjectID) bool](<#func-model-isuserfavorite>)
  - [func (m *model) SetVerifyCode(mail, code string) error](<#func-model-setverifycode>)
  - [func (m *model) UpdateCard(card Card) error](<#func-model-updatecard>)
  - [func (m *model) UpdateCardset(cardset Cardset) error](<#func-model-updatecardset>)
  - [func (m *model) UpdateComment(comment Comment) error](<#func-model-updatecomment>)
  - [func (m *model) UpdateFavorite(user, cardset string, liked bool) (bool, error)](<#func-model-updatefavorite>)
  - [func (m *model) UpdateFavoriteCount(id string, liked bool) error](<#func-model-updatefavoritecount>)
  - [func (m *model) UpdateLikedComment(comment, user string, liked bool) error](<#func-model-updatelikedcomment>)
  - [func (m *model) UpdateRecord(record Record) error](<#func-model-updaterecord>)
  - [func (m *model) UpdateUser(user User) error](<#func-model-updateuser>)
  - [func (m *model) UpdateVisitCount(id string) error](<#func-model-updatevisitcount>)
  - [func (m *model) VerifyCodeBlocking(mail string) (bool, error)](<#func-model-verifycodeblocking>)
- [type objArray](<#type-objarray>)


#### Constants

```go
const (
    QiniuUploadRecordDuration = time.Minute * 60 //七牛上传凭证的默认时长为1小时
)
```

```go
const colNameCard = "card"
```

```go
const colNameCardset = "cardset"
```

```go
const colNameComment = "comment"
```

```go
const colNameRecord = "record"
```

```go
const colNameUser = "user"
```

#### Variables

```go
var (
    ErrNotFound = mongo.ErrNoDocuments
    ErrExist    = errors.New("already existed")
    mongoClient *mongo.Client
)
```

```go
var redisClient *redis.Client
```

#### func AddQiniuUploadRecord

```go
func AddQiniuUploadRecord(key string, upload QiniuUpload) error
```

#### func GetMongoGlobalClient

```go
func GetMongoGlobalClient() *mongo.Client
```

#### func blockPrefix

```go
func blockPrefix(p string) string
```

#### func configPrefix

```go
func configPrefix(p string) string
```

#### func init

```go
func init()
```

#### func session

```go
func session(ctx context.Context, f func(ctx mongo.SessionContext) error) error
```

session 事务，但是需要mongo在cluster模式，慎用

#### type Card

Card struct in model layer

```go
type Card struct {
    ID  primitive.ObjectID `bson:"_id"`
    // CardsetID is ID of set that the card belongs to
    CardsetID primitive.ObjectID `bson:"cardset_id,omitempty"`
    Question  string             `bson:"question,omitempty"`
    Answer    string             `bson:"answer,omitempty"`
    Image     string             `bson:"image,omitempty"`
    Audio     string             `bson:"audio,omitempty"`
    Status    int                `bson:"status,omitempty"`

    // CreateTime is the first time of adding the card
    CreateTime int64 `bson:"create_time"`
    // LastUpdateTime is the last time of updating the card
    LastUpdateTime int64 `bson:"update_time"`
}
```

#### type CardInterface

```go
type CardInterface interface {
    AddCard(card Card) (string, error)
    AddCards(card []Card) ([]string, error)
    GetCard(id string) (Card, bool, error)
    GetCardByIDList(ids []primitive.ObjectID) ([]Card, error)
    GetCardInCardset(cardset string) ([]Card, error)
    DeleteCard(card Card) (bool, error)
    UpdateCard(card Card) error
    GetCount(cardset string) (int, error)
}
```

#### type Cardset

Cardset struct in model layer

```go
type Cardset struct {
    ID            primitive.ObjectID `bson:"_id"`
    OwnerID       primitive.ObjectID `bson:"owner_id,omitempty"`
    Name          string             `bson:"name,omitempty"`
    Description   string             `bson:"description,omitempty"`
    Access        int                `bson:"access,omitempty"`
    Status        int                `bson:"status,omitempty"`
    FavoriteCount int                `bson:"favorite_count,omitempty"`
    VisitCount    int                `bson:"visit_count,omitempty"`

    // CreateTime is the first time of adding the cardset
    CreateTime int64 `bson:"create_time,omitempty"`
    // LastUpdateTime is the last time of updating the cardset
    LastUpdateTime int64 `bson:"update_time,omitempty"`
}
```

#### type CardsetInterface

```go
type CardsetInterface interface {
    AddCardset(cardset Cardset) (string, error)
    GetCardset(id string) (Cardset, bool, error)
    DeleteCardset(cardset Cardset) (bool, error)
    UpdateCardset(cardset Cardset) error
    GetCardsetWithOwner(id, owner string) (Cardset, error)
    GetCardsetByOwner(owner string) ([]Cardset, error)
    GetCardsetByIDList(ids []primitive.ObjectID) ([]Cardset, error)
    GetCardsetByKeyword(keyword string, skip, limit int) ([]Cardset, error)
    GetRandomCardset(count int) ([]Cardset, error)
    UpdateFavoriteCount(id string, liked bool) error
    UpdateVisitCount(id string) error
}
```

#### type Comment

Comment struct in model layer

```go
type Comment struct {
    ID         primitive.ObjectID   `bson:"_id"`
    OwnerID    primitive.ObjectID   `bson:"owner_id,omitempty"`
    CardID     primitive.ObjectID   `bson:"card_id,omitempty"`
    Content    string               `bson:"comment,omitempty"`
    LikedUsers []primitive.ObjectID `bson:"liked_users,omitempty"`
    Status     int                  `bson:"status,omitempty"`

    // CreateTime is the first time of adding the comment
    CreateTime int64 `bson:"create_time"`
    // LastUpdateTime is the last time of updating the comment
    LastUpdateTime int64 `bson:"update_time"`
}
```

#### type CommentInterface

```go
type CommentInterface interface {
    AddComment(comment Comment) (string, error)
    GetComments(cardID string) ([]Comment, bool, error)
    UpdateComment(comment Comment) error
    DeleteComment(comment Comment) (bool, error)
    GetCommentWithOwner(commentID, owner string) (Comment, error)
    UpdateLikedComment(comment, user string, liked bool) error
    IsCommentsLiked(card, user string) ([]bool, error)
}
```

#### type Model

```go
type Model interface {
    // Close will close database connection
    Close()
    // Abort will stop all statement and roll back when using transaction
    Abort()
    // VerifyCode
    VerifyCodeBlocking(mail string) (bool, error)
    SetVerifyCode(mail, code string) error
    GetVerifyCode(mail string) (string, error)
    // UserInterface contains all user functions in model layer
    UserInterface
    // CardsetInterface contains all cardset functions in model layer
    CardsetInterface
    // CardInterface contains all card functions in model layer
    CardInterface
    // CommentInterface contains all comment functions in model layer
    CommentInterface
    // RecordInterface contains all record functions in model layer
    RecordInterface
}
```

##### func GetModel

```go
func GetModel() Model
```

#### type QiniuUpload

```go
type QiniuUpload struct {
    User primitive.ObjectID `json:"user"`
    Url  string             `json:"url"`
}
```

#### type Record

Card struct in model layer

```go
type Record struct {
    ID        primitive.ObjectID `bson:"_id"`
    OwnerID   primitive.ObjectID `bson:"owner_id,omitempty"`
    CardsetID primitive.ObjectID `bson:"cardset_id,omitempty"`
    // CardID is ID of card that the record belongs to
    CardID     primitive.ObjectID `bson:"card_id,omitempty"`
    LastStudy  int64              `bson:"last_study,omitempty"`
    StudyTimes int                `bson:"study_times,omitempty"`
    // Status 0 means not finish study and 1 otherwise
    Status int `bson:"status,omitempty"`
}
```

#### type RecordInterface

```go
type RecordInterface interface {
    UpdateRecord(record Record) error
    GetRecords(cardsetID, ownerID primitive.ObjectID) ([]Record, error)
    ClearRecords(cardsetID, ownerID primitive.ObjectID) error
    GetLastStudyTime(cardsetID, ownerID primitive.ObjectID) int64
}
```

#### type User

User struct in model layer

```go
type User struct {
    ID       primitive.ObjectID `bson:"_id"`
    Mail     string             `bson:"mail,omitempty"`
    Username string             `bson:"username,omitempty"`
    Password string             `bson:"password,omitempty"`
    // CreateTime is time of signing up
    CreateTime int64 `bson:"create_time"`
    // Favorite card sets of user
    Favorite []primitive.ObjectID `bson:"favorite,omitempty"`
    // Avatar image url
    Avatar string `bson:"avatar,omitempty"`
}
```

#### type UserInterface

```go
type UserInterface interface {
    AddUser(user User) (string, error)
    GetUser(id string) (User, bool, error)
    GetUserByMail(mail string) (user User, err error)
    UpdateUser(user User) error
    UpdateFavorite(user, cardset string, liked bool) (bool, error)
    IsUserFavorite(user string, cardsetID primitive.ObjectID) bool
}
```

#### type dbTrait

```go
type dbTrait struct {
    db *mongo.Database
}
```

##### func getDBTx

```go
func getDBTx(ctx context.Context) dbTrait
```

#### type model

```go
type model struct {
    dbTrait
    ctx    context.Context
    abort  bool
    cancel context.CancelFunc
}
```

##### func \(\*model\) Abort

```go
func (m *model) Abort()
```

##### func \(\*model\) AddCard

```go
func (m *model) AddCard(card Card) (string, error)
```

AddCard inserts a new card into database

##### func \(\*model\) AddCards

```go
func (m *model) AddCards(card []Card) ([]string, error)
```

AddCards inserts new cards into database

##### func \(\*model\) AddCardset

```go
func (m *model) AddCardset(cardset Cardset) (string, error)
```

AddCardset inserts a new cardset into database

##### func \(\*model\) AddComment

```go
func (m *model) AddComment(comment Comment) (string, error)
```

AddComment inserts a new comment into database

##### func \(\*model\) AddUser

```go
func (m *model) AddUser(user User) (string, error)
```

AddUser inserts a new user into database and will return \`ErrExist\` when user with same mail exist in database

##### func \(\*model\) ClearRecords

```go
func (m *model) ClearRecords(cardsetID, ownerID primitive.ObjectID) error
```

ClearRecords of certain cardset and user

##### func \(\*model\) Close

```go
func (m *model) Close()
```

##### func \(\*model\) DeleteCard

```go
func (m *model) DeleteCard(card Card) (bool, error)
```

DeleteCard by id\, returns the card exist and error

##### func \(\*model\) DeleteCardset

```go
func (m *model) DeleteCardset(cardset Cardset) (bool, error)
```

DeleteCardset by id\, returns the cardset exist and error

##### func \(\*model\) DeleteComment

```go
func (m *model) DeleteComment(comment Comment) (bool, error)
```

DeleteComment by id\, returns the comment exist and error

##### func \(\*model\) GetCard

```go
func (m *model) GetCard(id string) (Card, bool, error)
```

GetCard by id\, returns the card struct\, whether the card exist and error

##### func \(\*model\) GetCardByIDList

```go
func (m *model) GetCardByIDList(ids []primitive.ObjectID) ([]Card, error)
```

GetCardByIDList by id\, returns the card struct\, whether the card exist and error

##### func \(\*model\) GetCardInCardset

```go
func (m *model) GetCardInCardset(cardset string) ([]Card, error)
```

GetCardInCardset returns the card struct\, whether the card exist and error

##### func \(\*model\) GetCardset

```go
func (m *model) GetCardset(id string) (Cardset, bool, error)
```

GetCardset by id\, returns the cardset struct\, whether the cardset exist and error

##### func \(\*model\) GetCardsetByIDList

```go
func (m *model) GetCardsetByIDList(ids []primitive.ObjectID) ([]Cardset, error)
```

GetCardsetByIDList returns the card struct\, whether the card exist and error\.

##### func \(\*model\) GetCardsetByKeyword

```go
func (m *model) GetCardsetByKeyword(keyword string, skip, limit int) ([]Cardset, error)
```

GetCardsetByKeyword returns cardsets which contains keyword in name or description\.

##### func \(\*model\) GetCardsetByOwner

```go
func (m *model) GetCardsetByOwner(owner string) ([]Cardset, error)
```

GetCardsetByOwner owner id\, returns the cardset list created by the user\.

##### func \(\*model\) GetCardsetWithOwner

```go
func (m *model) GetCardsetWithOwner(id, owner string) (Cardset, error)
```

GetCardsetWithOwner by id and owner id\, returns the cardset struct\, whether the cardset exists and error

##### func \(\*model\) GetCommentWithOwner

```go
func (m *model) GetCommentWithOwner(commentID, owner string) (Comment, error)
```

GetCommentWithOwner by comment id & owner id\, returns the comment struct\, whether the comment exists and error

##### func \(\*model\) GetComments

```go
func (m *model) GetComments(cardID string) ([]Comment, bool, error)
```

GetComments by id\, returns the comments slice\, whether the comment exist and error

##### func \(\*model\) GetCount

```go
func (m *model) GetCount(cardset string) (int, error)
```

GetCount of cards in certain cardset

##### func \(\*model\) GetLastStudyTime

```go
func (m *model) GetLastStudyTime(cardsetID, ownerID primitive.ObjectID) int64
```

GetLastStudyTime of certain cardset and user

##### func \(\*model\) GetRandomCardset

```go
func (m *model) GetRandomCardset(count int) ([]Cardset, error)
```

GetRandomCardset returns cardsets which contains keyword in name or description\.

##### func \(\*model\) GetRecord

```go
func (m *model) GetRecord(cardsetID, cardID, ownerID primitive.ObjectID) (Record, error)
```

##### func \(\*model\) GetRecords

```go
func (m *model) GetRecords(cardsetID, ownerID primitive.ObjectID) ([]Record, error)
```

GetRecords of certain cardset and user

##### func \(\*model\) GetUser

```go
func (m *model) GetUser(id string) (User, bool, error)
```

GetUser by id\, returns the user struct\, whether the user exist and error

##### func \(\*model\) GetUserByMail

```go
func (m *model) GetUserByMail(mail string) (user User, err error)
```

GetUserByMail will get user by mail

##### func \(\*model\) GetVerifyCode

```go
func (m *model) GetVerifyCode(mail string) (string, error)
```

GetVerifyCode returns verify code of \`mail\` and returns \`ErrNotFound\` when there is no code of mail\.

##### func \(\*model\) IsCommentsLiked

```go
func (m *model) IsCommentsLiked(card, user string) ([]bool, error)
```

IsCommentsLiked will return whether comments under the card is liked by

##### func \(\*model\) IsUserFavorite

```go
func (m *model) IsUserFavorite(user string, cardsetID primitive.ObjectID) bool
```

##### func \(\*model\) SetVerifyCode

```go
func (m *model) SetVerifyCode(mail, code string) error
```

SetVerifyCode sets verify code of mail\.

##### func \(\*model\) UpdateCard

```go
func (m *model) UpdateCard(card Card) error
```

UpdateCard updates card info in database\, empty fields will be ignore

##### func \(\*model\) UpdateCardset

```go
func (m *model) UpdateCardset(cardset Cardset) error
```

UpdateCardset updates cardset info in database\, empty fields will be ignore

##### func \(\*model\) UpdateComment

```go
func (m *model) UpdateComment(comment Comment) error
```

UpdateComment updates comment info in database\, empty fields will be ignore

##### func \(\*model\) UpdateFavorite

```go
func (m *model) UpdateFavorite(user, cardset string, liked bool) (bool, error)
```

UpdateFavorite insert a cardset\_id into user document\, and return whether it was modified

##### func \(\*model\) UpdateFavoriteCount

```go
func (m *model) UpdateFavoriteCount(id string, liked bool) error
```

UpdateFavoriteCount will increase favorite count when liked is false and decrease otherwise\.

##### func \(\*model\) UpdateLikedComment

```go
func (m *model) UpdateLikedComment(comment, user string, liked bool) error
```

UpdateLikedComment by id\. If the comment is not liked by user\, add the user to liked\_users list; if the coment is liked by the user\, cancel it\.

##### func \(\*model\) UpdateRecord

```go
func (m *model) UpdateRecord(record Record) error
```

UpdateRecord inserts a new study record into database when it's not exist and update \`last\_study\` and \`study\_times\` otherwise\. Only record in different natural day \(UTC\+8\) will increase \`study\_times\`\.

##### func \(\*model\) UpdateUser

```go
func (m *model) UpdateUser(user User) error
```

UpdateUser updates user info in database\, empty fields will be ignore

##### func \(\*model\) UpdateVisitCount

```go
func (m *model) UpdateVisitCount(id string) error
```

UpdateVisitCount will increase visit count\.

##### func \(\*model\) VerifyCodeBlocking

```go
func (m *model) VerifyCodeBlocking(mail string) (bool, error)
```

VerifyCodeBlocking will check the duration after last mail and return true if the duration is too short\.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)

# 2. 系统测试

## 2.1. 测试用例

使用Postman进行测试，以下为测试样例。

以下所有测试样例均在Postman中测试通过，由于产品上线后数据库进行了重建，重新填充了基本数据，部分测试样例不可复现


#### Card



##### 1. AddCard



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6199cc3db4600da8e6102dac/card
```



***Body:***

```js        
{
    "question":"test-card",
    "answer":"ans"
}
```



##### 2. AddCardMany



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/61bf516525a8f77f0438048b/card/many
```



***Body:***

```js        
{
    "cards":[]
}
```



##### 3. DeleteCard



***Endpoint:***

```bash
Method: DELETE
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6193c1cfd9598aa1a050b041/card/6193c81e9c133d1f109640bf
```



***Body:***

```js        
{
    "question":"test-card",
    "answer":"ans"
}
```



##### 4. GetCard



***Endpoint:***

```bash
Method: GET
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6199cc3db4600da8e6102dac/card/6199cc46b4600da8e6102dad
```



***Body:***

```js        
{
    "question":"test-card",
    "answer":"ans"
}
```



##### 5. GetCards



***Endpoint:***

```bash
Method: GET
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6199cc3db4600da8e6102dac/card
```



***Query params:***

| Key | Value | Description |
| --- | ------|-------------|
| ids | ["6199cc46b4600da8e6102dad"] |  |



***Body:***

```js        
{
    "question":"test-card",
    "answer":"ans"
}
```



##### 7. UpdateCard



***Endpoint:***

```bash
Method: PUT
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6199cc3db4600da8e6102dac/card/6199cc46b4600da8e6102dad
```



***Body:***

```js        
{
    "question":"test-card------",
    "answer":"ans1"
}
```



#### Cardset



##### 1. AddCardset



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset
```



***Body:***

```js        
{
    "name":"test-cards222222",
    "description":"test test.",
    "access":1
}
```



##### 2. DeleteCardset



***Endpoint:***

```bash
Method: DELETE
Type: 
URL: http://127.0.0.1:3000/api/v1/cardset/6193c162d9598aa1a050b040
```



##### 3. GetCardset



***Endpoint:***

```bash
Method: GET
Type: 
URL: http://127.0.0.1:3000/api/v1/cardset/61bf12e4c6c8dc0f5048b84a
```



##### 4. RandomCardset



***Endpoint:***

```bash
Method: GET
Type: 
URL: http://127.0.0.1:3000/api/v1/cardset/random
```



***Query params:***

| Key | Value | Description |
| --- | ------|-------------|
| count | 10 |  |



##### 5. SearchCardset



***Endpoint:***

```bash
Method: GET
Type: 
URL: http://127.0.0.1:3000/api/v1/cardset
```



***Query params:***

| Key | Value | Description |
| --- | ------|-------------|
| keyword | cards222222 |  |



##### 6. UpdateCardset



***Endpoint:***

```bash
Method: PUT
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6193c162d9598aa1a050b040
```



***Body:***

```js        
{
    "name":"test-cards",
    "description":"test test1.",
    "access":1
}
```



#### Comment



##### 1. AddComment



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6199cc3db4600da8e6102dac/card/:id/comment
```



***URL variables:***

| Key | Value | Description |
| --- | ------|-------------|
| id | 619b3df9441373383bc6c6dc | Card ID |



***Body:***

```js        
{
    "comment":"here is a test comment"
}
```



##### 2. DeleteComment



***Endpoint:***

```bash
Method: DELETE
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6193c1cfd9598aa1a050b041/card/6193c81e9c133d1f109640bf
```



***Body:***

```js        
{
    "question":"test-card",
    "answer":"ans"
}
```



##### 3. GetComments



***Endpoint:***

```bash
Method: GET
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6199cc3db4600da8e6102dac/card/:id/comment
```



***URL variables:***

| Key | Value | Description |
| --- | ------|-------------|
| id | 619b3df9441373383bc6c6dc |  |



***Body:***

```js        
{
    "question":"test-card",
    "answer":"ans"
}
```



##### 4. LikeComment



***Endpoint:***

```bash
Method: PUT
Type: RAW
URL: http://127.0.0.1:3000/api/v1/cardset/6199cc3db4600da8e6102dac/card/:id/comment/619b3e39441373383bc6c6dd/like
```



***URL variables:***

| Key | Value | Description |
| --- | ------|-------------|
| id | 619b3df9441373383bc6c6dc |  |



***Body:***

```js        
{
    "liked": false
}
```



#### Record



##### 1. DeleteRecords



***Endpoint:***

```bash
Method: DELETE
Type: 
URL: http://127.0.0.1:3000/api/v1/record/6199cc3db4600da8e6102dac
```



##### 2. GetRecords



***Endpoint:***

```bash
Method: GET
Type: 
URL: http://127.0.0.1:3000/api/v1/record/6199cc3db4600da8e6102dac
```



##### 3. UpdateRecord



***Endpoint:***

```bash
Method: POST
Type: 
URL: http://127.0.0.1:3000/api/v1/record/6199cc3db4600da8e6102dac/6199cc46b4600da8e6102dad
```



#### Service



##### 1. GetQiniuToken



***Endpoint:***

```bash
Method: GET
Type: 
URL: http://127.0.0.1:3000/api/v1/service/upload_token
```



***Query params:***

| Key | Value | Description |
| --- | ------|-------------|
| type | avatar |  |



#### User



##### 1. AddFavorite



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/user/favorite
```



***Body:***

```js        
{
  "cardset_id": "6199cc3db4600da8e6102dac",
  "liked": false
}
```



##### 2. AddUser



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/signup
```



***Body:***

```js        
{
    "mail":"2460563632@qq.com",
    "username":"test",
    "password":"123456",
    "code":"20145"
}
```



##### 3. GetCreated



***Endpoint:***

```bash
Method: GET
Type: 
URL: http://127.0.0.1:3000/api/v1/user/created
```



##### 4. GetFavorite



***Endpoint:***

```bash
Method: GET
Type: 
URL: http://127.0.0.1:3000/api/v1/user/favorite
```



##### 5. GetUser



***Endpoint:***

```bash
Method: GET
Type: 
URL: http://127.0.0.1:3000/api/v1/user
```



##### 6. UpdateFavorite



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/user/favorite
```



***Body:***

```js        
{
    "cardset_id":"6199cc3db4600da8e6102dac"
}
```



##### 7. UpdateUser



***Endpoint:***

```bash
Method: PUT
Type: RAW
URL: http://127.0.0.1:3000/api/v1/user
```



***Body:***

```js        
{
    "avatar": "1"
}
```



#### Ungrouped



##### 1. Login



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/login
```



***Body:***

```js        
{
    "mail":"2460563632@qq.com",
    "password":"123456"
}
```



##### 2. VerifyCode



***Endpoint:***

```bash
Method: POST
Type: RAW
URL: http://127.0.0.1:3000/api/v1/verify
```



***Body:***

```js        
{
    "mail":"2460563632@qq.com"
}
```



***Available Variables:***

| Key | Value | Type |
| --- | ------|-------------|
| path | http://127.0.0.1:3000/api/v1 |  |
| path | https://flicker.woolensheep.top/api/v1 |  |



## 2.2. 线上测试

程序部署到https://flicker.woolensheep.top，并且正常运行了两周，期间对其所有功能进行了测试，包括对于常见异常状况的处理，均未发现问题。

## 2.3. 结果分析

根据测试分析运行结果、确认软件是否满足需求。

由Ungrouped测试可知，可以正常发送验证邮件，并且新建用户。

由User测试可知，可以正常新建用户、获取用户并且更改用户的基本信息。同时可以更新用户的收藏列表，并且正常获取用户的收藏列表以及创建列表。

由Cardset测试可知，可以正常对卡片集资源进行增删改查，以及返回随机卡片集列表。

由Card测试可知，可以正常对卡片资源进行增删改查，可以正常批量新建卡片。

由Comment测试可知，可以正常发表评论，正常获取评论列表以及对评论进行点赞或者删除评论。

由Service测试可知，该网站后端正常接入了七牛云存储平台，能够返回正确的token。

由Record测试可知，该网站能够正常记录用户的学习记录，并且推荐合适的学习计划。

由线上测试知，该网页应用可以持续、稳定地在线运行，并且能够处理用户的异常请求。

