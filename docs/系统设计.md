[TOC]

# 1. 系统结构

## 1.1. 前端系统结构

前端系统分为 9 个模块:

1. 注册账号模块。注册功能分为六个步骤，填入用户名、填入密码、填入确认密码、点击注册按钮、传递用户信息的后端管理判断、后台返回响应。
2. 账号登入模块。主要的登录功能分为五个步骤，填入用户名、填入密码点击注册按钮、传递用户信息的后端管理判断、后台返回响应。
3. 修改密码模块。
4. 选课主界面模块。主要功能: 提供给学生选课退课、提供给所有用户利用课程名字或者课程分类来检索课程。提供给所有用户跳转到其他页面的按钮。
5. 个人信息界面模块 。主要功能: 提示用户当前的身份（学生、老师、管理员）、基本的个人信息，以及已经选择的课程和选择课程的成功率是多大，提供给所有用户跳转到其他页面的按钮。
6. 个人信息修改界面模块。主要功能: 提供用户修改个人基本信息，能够修改用户的身份。提供给所有用户跳转到其他页面的按钮。
7. 课程讨论界面模块。主要功能: 可以给学生、老师进行发言，发言会公布到页面中去。
8. 课程评价界面模块。
9. 老师上传课程界面模块。主要功能: 老师填写课程的信息，课程能够上传到选课主页面中。

## 1.2. 后端系统结构

后端系统的功能模块分为路由模块（view）、控制模块（controller）与数据库模块（model）。

各个模块又分为用户模块，卡片集模块，卡片模块，评论模块，学习记录模块。

1. 其中用户模块包括用户账号注册，用户账号的增改查。

   详细信息见实现与测试以及API文档。

1. 卡片集模块实现了卡片集的增删改查，以及卡片集的收藏。

   详细信息见实现与测试以及API文档。

1. 卡片模块实现了卡片的增删改查。

   详细信息见实现与测试以及API文档。

1. 评论模块实现了评论的发表与删除，以及点赞功能
   
   详细信息见实现与测试以及API文档。
   
1. 学习记录模块实现了用户所有的学习轨迹的记录
   
   1. 数据主要提供给推荐算法为用户推荐适合的卡片
   1. 详细信息见实现与测试以及API文档。

## 1.3. 系统结构图:



## 1.4. 系统类图

由于golang语言的特殊性，语言中不存在类的概念。

## 1.5. 关键数据结构定义

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

```go
import "github.com/woolen-sheep/Flicker-BE/controller/param"
```

#### Index

- [Variables](<#variables>)
- [type AddCollectionRequest](<#type-addcollectionrequest>)
- [type CardCommentRequest](<#type-cardcommentrequest>)
- [type CardsetInfoResponse](<#type-cardsetinforesponse>)
- [type CommentResponseItem](<#type-commentresponseitem>)
- [type GetCardResponse](<#type-getcardresponse>)
- [type GetCardsetResponse](<#type-getcardsetresponse>)
- [type GetCommentResponse](<#type-getcommentresponse>)
- [type GetQiniuTokenRequest](<#type-getqiniutokenrequest>)
- [type GetRecordsRespons](<#type-getrecordsrespons>)
- [type LikeCommentRequest](<#type-likecommentrequest>)
- [type LoginRequest](<#type-loginrequest>)
- [type LoginResponse](<#type-loginresponse>)
- [type NewCardRequest](<#type-newcardrequest>)
- [type NewCardsRequest](<#type-newcardsrequest>)
- [type NewCardsetRequest](<#type-newcardsetrequest>)
- [type NewCommentRequest](<#type-newcommentrequest>)
- [type PageRequest](<#type-pagerequest>)
- [type QiniuAuthentication](<#type-qiniuauthentication>)
- [type RandomCardsetsRequest](<#type-randomcardsetsrequest>)
- [type RecordResponse](<#type-recordresponse>)
- [type SearchCardsetRequest](<#type-searchcardsetrequest>)
- [type SignUpRequest](<#type-signuprequest>)
- [type UpdateCardRequest](<#type-updatecardrequest>)
- [type UpdateCardsetRequest](<#type-updatecardsetrequest>)
- [type UpdateRecordRequest](<#type-updaterecordrequest>)
- [type UpdateUserRequest](<#type-updateuserrequest>)
- [type User](<#type-user>)
- [type UserResponse](<#type-userresponse>)
- [type VerifyCodeRequest](<#type-verifycoderequest>)


#### Variables

```go
var (
    DefaultPageRequest = PageRequest{
        Skip:  0,
        Limit: 10,
    }
)
```

#### type AddCollectionRequest

```go
type AddCollectionRequest struct {
    CardsetID string `json:"cardset_id" validate:"required"`
    Liked     bool   `json:"liked"`
}
```

#### type CardCommentRequest

```go
type CardCommentRequest struct {
    Comment string `json:"comment"`
}
```

#### type CardsetInfoResponse

```go
type CardsetInfoResponse struct {
    ID          string `json:"id"`
    OwnerID     string `json:"owner_id,omitempty"`
    Name        string `json:"name,omitempty"`
    Description string `json:"description,omitempty"`
    Access      int    `json:"access,omitempty"`
}
```

#### type CommentResponseItem

```go
type CommentResponseItem struct {
    ID         string       `json:"id"`
    Owner      UserResponse `json:"owner"`
    Comment    string       `json:"comment"`
    LastUpdate string       `json:"lastupdate"`
    Liked      bool         `json:"liked"`
    Likes      int          `json:"likes"`
}
```

#### type GetCardResponse

```go
type GetCardResponse struct {
    ID       string `json:"id"`
    Question string `json:"question"`
    Answer   string `json:"answer"`
    Image    string `json:"image"`
    Audio    string `json:"audio"`
}
```

#### type GetCardsetResponse

```go
type GetCardsetResponse struct {
    ID            string   `json:"id"`
    OwnerID       string   `json:"owner_id"`
    OwnerName     string   `json:"owner_name"`
    Name          string   `json:"name"`
    Description   string   `json:"description"`
    Access        int      `json:"access"`
    FavoriteCount int      `json:"favorite_count"`
    VisitCount    int      `json:"visit_count"`
    CreateTime    int64    `json:"create_time"`
    Cards         []string `json:"cards"`
    IsFavorite    bool     `json:"is_favorite"`
    LastStudy     int64    `json:"last_study"`
}
```

#### type GetCommentResponse

```go
type GetCommentResponse = []CommentResponseItem
```

#### type GetQiniuTokenRequest

```go
type GetQiniuTokenRequest struct {
    URL         string `json:"url"`
    ResourceKey string `json:"resource_key"`
    Token       string `json:"token"`
}
```

#### type GetRecordsRespons

```go
type GetRecordsRespons struct {
    Total   int              `json:"total"`
    Records []RecordResponse `json:"records"`
}
```

#### type LikeCommentRequest

```go
type LikeCommentRequest struct {
    Liked bool `json:"liked"`
}
```

#### type LoginRequest

```go
type LoginRequest struct {
    Mail     string `json:"mail" validate:"required"`
    Password string `json:"password" validate:"required"`
}
```

#### type LoginResponse

```go
type LoginResponse struct {
    Mail     string `json:"mail" validate:"required"`
    Password string `json:"password" validate:"required"`
}
```

#### type NewCardRequest

```go
type NewCardRequest struct {
    Question string `json:"question"`
    Answer   string `json:"answer"`
    Image    string `json:"image"`
    Audio    string `json:"audio"`
}
```

#### type NewCardsRequest

```go
type NewCardsRequest struct {
    Cards []NewCardRequest `json:"cards"`
}
```

#### type NewCardsetRequest

```go
type NewCardsetRequest struct {
    Name        string `json:"name" validate:"required"`
    Description string `json:"description"`
    Access      int    `json:"access"`
}
```

#### type NewCommentRequest

```go
type NewCommentRequest struct {
    Comment string `json:"comment" validate:"required"`
}
```

#### type PageRequest

```go
type PageRequest struct {
    Skip  int `query:"skip"`
    Limit int `query:"limit"`
}
```

#### type QiniuAuthentication

```go
type QiniuAuthentication struct {
    Url         string ``
    Method      string
    Path        string
    RawQuery    string
    Host        string
    ContentType string
    BodyStr     string
}
```

#### type RandomCardsetsRequest

```go
type RandomCardsetsRequest struct {
    Count int `query:"count" validate:"required"`
}
```

#### type RecordResponse

```go
type RecordResponse struct {
    CardID     string `json:"card_id"`
    LastStudy  int64  `json:"last_study"`
    StudyTimes int    `json:"study_times"`
    Status     int    `json:"status"`
}
```

#### type SearchCardsetRequest

```go
type SearchCardsetRequest struct {
    PageRequest
    Keyword string `query:"keyword"`
}
```

#### type SignUpRequest

```go
type SignUpRequest struct {
    Mail     string `json:"mail" validate:"required"`
    Username string `json:"username" validate:"required"`
    Password string `json:"password" validate:"required"`
    Code     string `json:"code" validate:"required"`
}
```

#### type UpdateCardRequest

```go
type UpdateCardRequest struct {
    Question string `json:"question"`
    Answer   string `json:"answer"`
    Image    string `json:"image"`
    Audio    string `json:"audio"`
}
```

#### type UpdateCardsetRequest

```go
type UpdateCardsetRequest struct {
    Name        string `json:"name"`
    Description string `json:"description"`
    Access      int    `json:"access"`
}
```

#### type UpdateRecordRequest

```go
type UpdateRecordRequest struct {
    Status int `json:"status"`
}
```

#### type UpdateUserRequest

```go
type UpdateUserRequest struct {
    Username string `json:"username"`
    Password string `json:"password"`
    Avatar   string `json:"avatar"`
}
```

#### type User

```go
type User struct {
    Mail     string `json:"mail"`
    Username string `json:"username"`
    Password string `json:"password"`
    Avatar   string `json:"avatar"`
}
```

#### type UserResponse

```go
type UserResponse struct {
    ID       string   `json:"id"`
    Username string   `json:"username"`
    Avatar   string   `json:"avatar"`
    Favorite []string `json:"favorite"`
}
```

#### type VerifyCodeRequest

```go
type VerifyCodeRequest struct {
    Mail string `json:"mail" validate:"required"`
}
```

### model

```go
import "github.com/woolen-sheep/Flicker-BE/model"
```

#### Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [type Card](<#type-card>)
- [type CardInterface](<#type-cardinterface>)
- [type Cardset](<#type-cardset>)
- [type CardsetInterface](<#type-cardsetinterface>)
- [type Comment](<#type-comment>)
- [type CommentInterface](<#type-commentinterface>)
- [type Model](<#type-model>)
  - [func GetModel() Model](<#func-getmodel>)
- [type QiniuUpload](<#type-qiniuupload>)
- [type Record](<#type-record>)
- [type RecordInterface](<#type-recordinterface>)
- [type User](<#type-user>)
- [type UserInterface](<#type-userinterface>)


#### Constants

```go
const (
    QiniuUploadRecordDuration = time.Minute * 60 //七牛上传凭证的默认时长为1小时
)
```

#### Variables

```go
var (
    ErrNotFound = mongo.ErrNoDocuments
    ErrExist    = errors.New("already existed")
)
```

#### type Card

Card struct in model layer

```go
type Card struct {
    ID  primitive.ObjectID `bson:"_id"`
    // CardsetID is ID of set that the card belongs to
    CardsetID primitive.ObjectID `bson:"cardset_id,omitempty"`
    Question  string             `bson:"question,omitempty"`
    Answer    string             `bson:"answer,omitempty"`
    Image     string             `bson:"image,omitempty"`
    Audio     string             `bson:"audio,omitempty"`
    Status    int                `bson:"status,omitempty"`

    // CreateTime is the first time of adding the card
    CreateTime int64 `bson:"create_time"`
    // LastUpdateTime is the last time of updating the card
    LastUpdateTime int64 `bson:"update_time"`
}
```

#### type CardInterface

```go
type CardInterface interface {
    AddCard(card Card) (string, error)
    AddCards(card []Card) ([]string, error)
    GetCard(id string) (Card, bool, error)
    GetCardByIDList(ids []primitive.ObjectID) ([]Card, error)
    GetCardInCardset(cardset string) ([]Card, error)
    DeleteCard(card Card) (bool, error)
    UpdateCard(card Card) error
    GetCount(cardset string) (int, error)
}
```

#### type Cardset

Cardset struct in model layer

```go
type Cardset struct {
    ID            primitive.ObjectID `bson:"_id"`
    OwnerID       primitive.ObjectID `bson:"owner_id,omitempty"`
    Name          string             `bson:"name,omitempty"`
    Description   string             `bson:"description,omitempty"`
    Access        int                `bson:"access,omitempty"`
    Status        int                `bson:"status,omitempty"`
    FavoriteCount int                `bson:"favorite_count,omitempty"`
    VisitCount    int                `bson:"visit_count,omitempty"`

    // CreateTime is the first time of adding the cardset
    CreateTime int64 `bson:"create_time,omitempty"`
    // LastUpdateTime is the last time of updating the cardset
    LastUpdateTime int64 `bson:"update_time,omitempty"`
}
```

#### type CardsetInterface

```go
type CardsetInterface interface {
    AddCardset(cardset Cardset) (string, error)
    GetCardset(id string) (Cardset, bool, error)
    DeleteCardset(cardset Cardset) (bool, error)
    UpdateCardset(cardset Cardset) error
    GetCardsetWithOwner(id, owner string) (Cardset, error)
    GetCardsetByOwner(owner string) ([]Cardset, error)
    GetCardsetByIDList(ids []primitive.ObjectID) ([]Cardset, error)
    GetCardsetByKeyword(keyword string, skip, limit int) ([]Cardset, error)
    GetRandomCardset(count int) ([]Cardset, error)
    UpdateFavoriteCount(id string, liked bool) error
    UpdateVisitCount(id string) error
}
```

#### type Comment

Comment struct in model layer

```go
type Comment struct {
    ID         primitive.ObjectID   `bson:"_id"`
    OwnerID    primitive.ObjectID   `bson:"owner_id,omitempty"`
    CardID     primitive.ObjectID   `bson:"card_id,omitempty"`
    Content    string               `bson:"comment,omitempty"`
    LikedUsers []primitive.ObjectID `bson:"liked_users,omitempty"`
    Status     int                  `bson:"status,omitempty"`

    // CreateTime is the first time of adding the comment
    CreateTime int64 `bson:"create_time"`
    // LastUpdateTime is the last time of updating the comment
    LastUpdateTime int64 `bson:"update_time"`
}
```

#### type CommentInterface

```go
type CommentInterface interface {
    AddComment(comment Comment) (string, error)
    GetComments(cardID string) ([]Comment, bool, error)
    UpdateComment(comment Comment) error
    DeleteComment(comment Comment) (bool, error)
    GetCommentWithOwner(commentID, owner string) (Comment, error)
    UpdateLikedComment(comment, user string, liked bool) error
    IsCommentsLiked(card, user string) ([]bool, error)
}
```

#### type Model

```go
type Model interface {
    // Close will close database connection
    Close()
    // Abort will stop all statement and roll back when using transaction
    Abort()
    // VerifyCode
    VerifyCodeBlocking(mail string) (bool, error)
    SetVerifyCode(mail, code string) error
    GetVerifyCode(mail string) (string, error)
    // UserInterface contains all user functions in model layer
    UserInterface
    // CardsetInterface contains all cardset functions in model layer
    CardsetInterface
    // CardInterface contains all card functions in model layer
    CardInterface
    // CommentInterface contains all comment functions in model layer
    CommentInterface
    // RecordInterface contains all record functions in model layer
    RecordInterface
}
```

##### func GetModel

```go
func GetModel() Model
```

#### type QiniuUpload

```go
type QiniuUpload struct {
    User primitive.ObjectID `json:"user"`
    Url  string             `json:"url"`
}
```

#### type Record

Card struct in model layer

```go
type Record struct {
    ID        primitive.ObjectID `bson:"_id"`
    OwnerID   primitive.ObjectID `bson:"owner_id,omitempty"`
    CardsetID primitive.ObjectID `bson:"cardset_id,omitempty"`
    // CardID is ID of card that the record belongs to
    CardID     primitive.ObjectID `bson:"card_id,omitempty"`
    LastStudy  int64              `bson:"last_study,omitempty"`
    StudyTimes int                `bson:"study_times,omitempty"`
    // Status 0 means not finish study and 1 otherwise
    Status int `bson:"status,omitempty"`
}
```

#### type RecordInterface

```go
type RecordInterface interface {
    UpdateRecord(record Record) error
    GetRecords(cardsetID, ownerID primitive.ObjectID) ([]Record, error)
    ClearRecords(cardsetID, ownerID primitive.ObjectID) error
    GetLastStudyTime(cardsetID, ownerID primitive.ObjectID) int64
}
```

#### type User

User struct in model layer

```go
type User struct {
    ID       primitive.ObjectID `bson:"_id"`
    Mail     string             `bson:"mail,omitempty"`
    Username string             `bson:"username,omitempty"`
    Password string             `bson:"password,omitempty"`
    // CreateTime is time of signing up
    CreateTime int64 `bson:"create_time"`
    // Favorite card sets of user
    Favorite []primitive.ObjectID `bson:"favorite,omitempty"`
    // Avatar image url
    Avatar string `bson:"avatar,omitempty"`
}
```

#### type UserInterface

```go
type UserInterface interface {
    AddUser(user User) (string, error)
    GetUser(id string) (User, bool, error)
    GetUserByMail(mail string) (user User, err error)
    UpdateUser(user User) error
    UpdateFavorite(user, cardset string, liked bool) (bool, error)
    IsUserFavorite(user string, cardsetID primitive.ObjectID) bool
}
```



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


## 1.6. 关键算法设计

<a id="markdown-161-数据库的api接口算法设计" name="161-数据库的api接口算法设计"></a>

### 1.6.1. 数据库的 API 接口算法设计

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

```go
import "github.com/woolen-sheep/Flicker-BE/model"
```

#### Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [func AddQiniuUploadRecord(key string, upload QiniuUpload) error](<#func-addqiniuuploadrecord>)
- [func GetMongoGlobalClient() *mongo.Client](<#func-getmongoglobalclient>)
- [func blockPrefix(p string) string](<#func-blockprefix>)
- [func configPrefix(p string) string](<#func-configprefix>)
- [func init()](<#func-init>)
- [func session(ctx context.Context, f func(ctx mongo.SessionContext) error) error](<#func-session>)
- [type Card](<#type-card>)
- [type CardInterface](<#type-cardinterface>)
- [type Cardset](<#type-cardset>)
- [type CardsetInterface](<#type-cardsetinterface>)
- [type Comment](<#type-comment>)
- [type CommentInterface](<#type-commentinterface>)
- [type Model](<#type-model>)
  - [func GetModel() Model](<#func-getmodel>)
- [type QiniuUpload](<#type-qiniuupload>)
- [type Record](<#type-record>)
- [type RecordInterface](<#type-recordinterface>)
- [type User](<#type-user>)
- [type UserInterface](<#type-userinterface>)
- [type dbTrait](<#type-dbtrait>)
  - [func getDBTx(ctx context.Context) dbTrait](<#func-getdbtx>)
- [type model](<#type-model>)
  - [func (m *model) Abort()](<#func-model-abort>)
  - [func (m *model) AddCard(card Card) (string, error)](<#func-model-addcard>)
  - [func (m *model) AddCards(card []Card) ([]string, error)](<#func-model-addcards>)
  - [func (m *model) AddCardset(cardset Cardset) (string, error)](<#func-model-addcardset>)
  - [func (m *model) AddComment(comment Comment) (string, error)](<#func-model-addcomment>)
  - [func (m *model) AddUser(user User) (string, error)](<#func-model-adduser>)
  - [func (m *model) ClearRecords(cardsetID, ownerID primitive.ObjectID) error](<#func-model-clearrecords>)
  - [func (m *model) Close()](<#func-model-close>)
  - [func (m *model) DeleteCard(card Card) (bool, error)](<#func-model-deletecard>)
  - [func (m *model) DeleteCardset(cardset Cardset) (bool, error)](<#func-model-deletecardset>)
  - [func (m *model) DeleteComment(comment Comment) (bool, error)](<#func-model-deletecomment>)
  - [func (m *model) GetCard(id string) (Card, bool, error)](<#func-model-getcard>)
  - [func (m *model) GetCardByIDList(ids []primitive.ObjectID) ([]Card, error)](<#func-model-getcardbyidlist>)
  - [func (m *model) GetCardInCardset(cardset string) ([]Card, error)](<#func-model-getcardincardset>)
  - [func (m *model) GetCardset(id string) (Cardset, bool, error)](<#func-model-getcardset>)
  - [func (m *model) GetCardsetByIDList(ids []primitive.ObjectID) ([]Cardset, error)](<#func-model-getcardsetbyidlist>)
  - [func (m *model) GetCardsetByKeyword(keyword string, skip, limit int) ([]Cardset, error)](<#func-model-getcardsetbykeyword>)
  - [func (m *model) GetCardsetByOwner(owner string) ([]Cardset, error)](<#func-model-getcardsetbyowner>)
  - [func (m *model) GetCardsetWithOwner(id, owner string) (Cardset, error)](<#func-model-getcardsetwithowner>)
  - [func (m *model) GetCommentWithOwner(commentID, owner string) (Comment, error)](<#func-model-getcommentwithowner>)
  - [func (m *model) GetComments(cardID string) ([]Comment, bool, error)](<#func-model-getcomments>)
  - [func (m *model) GetCount(cardset string) (int, error)](<#func-model-getcount>)
  - [func (m *model) GetLastStudyTime(cardsetID, ownerID primitive.ObjectID) int64](<#func-model-getlaststudytime>)
  - [func (m *model) GetRandomCardset(count int) ([]Cardset, error)](<#func-model-getrandomcardset>)
  - [func (m *model) GetRecord(cardsetID, cardID, ownerID primitive.ObjectID) (Record, error)](<#func-model-getrecord>)
  - [func (m *model) GetRecords(cardsetID, ownerID primitive.ObjectID) ([]Record, error)](<#func-model-getrecords>)
  - [func (m *model) GetUser(id string) (User, bool, error)](<#func-model-getuser>)
  - [func (m *model) GetUserByMail(mail string) (user User, err error)](<#func-model-getuserbymail>)
  - [func (m *model) GetVerifyCode(mail string) (string, error)](<#func-model-getverifycode>)
  - [func (m *model) IsCommentsLiked(card, user string) ([]bool, error)](<#func-model-iscommentsliked>)
  - [func (m *model) IsUserFavorite(user string, cardsetID primitive.ObjectID) bool](<#func-model-isuserfavorite>)
  - [func (m *model) SetVerifyCode(mail, code string) error](<#func-model-setverifycode>)
  - [func (m *model) UpdateCard(card Card) error](<#func-model-updatecard>)
  - [func (m *model) UpdateCardset(cardset Cardset) error](<#func-model-updatecardset>)
  - [func (m *model) UpdateComment(comment Comment) error](<#func-model-updatecomment>)
  - [func (m *model) UpdateFavorite(user, cardset string, liked bool) (bool, error)](<#func-model-updatefavorite>)
  - [func (m *model) UpdateFavoriteCount(id string, liked bool) error](<#func-model-updatefavoritecount>)
  - [func (m *model) UpdateLikedComment(comment, user string, liked bool) error](<#func-model-updatelikedcomment>)
  - [func (m *model) UpdateRecord(record Record) error](<#func-model-updaterecord>)
  - [func (m *model) UpdateUser(user User) error](<#func-model-updateuser>)
  - [func (m *model) UpdateVisitCount(id string) error](<#func-model-updatevisitcount>)
  - [func (m *model) VerifyCodeBlocking(mail string) (bool, error)](<#func-model-verifycodeblocking>)
  - [func (m *model) cardC() *mongo.Collection](<#func-model-cardc>)
  - [func (m *model) cardsetC() *mongo.Collection](<#func-model-cardsetc>)
  - [func (m *model) commentC() *mongo.Collection](<#func-model-commentc>)
  - [func (m *model) recordC() *mongo.Collection](<#func-model-recordc>)
  - [func (m *model) userC() *mongo.Collection](<#func-model-userc>)
- [type objArray](<#type-objarray>)


#### Constants

```go
const (
    QiniuUploadRecordDuration = time.Minute * 60 //七牛上传凭证的默认时长为1小时
)
```

```go
const colNameCard = "card"
```

```go
const colNameCardset = "cardset"
```

```go
const colNameComment = "comment"
```

```go
const colNameRecord = "record"
```

```go
const colNameUser = "user"
```

#### Variables

```go
var (
    ErrNotFound = mongo.ErrNoDocuments
    ErrExist    = errors.New("already existed")
    mongoClient *mongo.Client
)
```

```go
var redisClient *redis.Client
```

#### func AddQiniuUploadRecord

```go
func AddQiniuUploadRecord(key string, upload QiniuUpload) error
```

#### func GetMongoGlobalClient

```go
func GetMongoGlobalClient() *mongo.Client
```

#### func blockPrefix

```go
func blockPrefix(p string) string
```

#### func configPrefix

```go
func configPrefix(p string) string
```

#### func init

```go
func init()
```

#### func session

```go
func session(ctx context.Context, f func(ctx mongo.SessionContext) error) error
```

session 事务，但是需要mongo在cluster模式，慎用

#### type Card

Card struct in model layer

```go
type Card struct {
    ID  primitive.ObjectID `bson:"_id"`
    // CardsetID is ID of set that the card belongs to
    CardsetID primitive.ObjectID `bson:"cardset_id,omitempty"`
    Question  string             `bson:"question,omitempty"`
    Answer    string             `bson:"answer,omitempty"`
    Image     string             `bson:"image,omitempty"`
    Audio     string             `bson:"audio,omitempty"`
    Status    int                `bson:"status,omitempty"`

    // CreateTime is the first time of adding the card
    CreateTime int64 `bson:"create_time"`
    // LastUpdateTime is the last time of updating the card
    LastUpdateTime int64 `bson:"update_time"`
}
```

#### type CardInterface

```go
type CardInterface interface {
    AddCard(card Card) (string, error)
    AddCards(card []Card) ([]string, error)
    GetCard(id string) (Card, bool, error)
    GetCardByIDList(ids []primitive.ObjectID) ([]Card, error)
    GetCardInCardset(cardset string) ([]Card, error)
    DeleteCard(card Card) (bool, error)
    UpdateCard(card Card) error
    GetCount(cardset string) (int, error)
}
```

#### type Cardset

Cardset struct in model layer

```go
type Cardset struct {
    ID            primitive.ObjectID `bson:"_id"`
    OwnerID       primitive.ObjectID `bson:"owner_id,omitempty"`
    Name          string             `bson:"name,omitempty"`
    Description   string             `bson:"description,omitempty"`
    Access        int                `bson:"access,omitempty"`
    Status        int                `bson:"status,omitempty"`
    FavoriteCount int                `bson:"favorite_count,omitempty"`
    VisitCount    int                `bson:"visit_count,omitempty"`

    // CreateTime is the first time of adding the cardset
    CreateTime int64 `bson:"create_time,omitempty"`
    // LastUpdateTime is the last time of updating the cardset
    LastUpdateTime int64 `bson:"update_time,omitempty"`
}
```

#### type CardsetInterface

```go
type CardsetInterface interface {
    AddCardset(cardset Cardset) (string, error)
    GetCardset(id string) (Cardset, bool, error)
    DeleteCardset(cardset Cardset) (bool, error)
    UpdateCardset(cardset Cardset) error
    GetCardsetWithOwner(id, owner string) (Cardset, error)
    GetCardsetByOwner(owner string) ([]Cardset, error)
    GetCardsetByIDList(ids []primitive.ObjectID) ([]Cardset, error)
    GetCardsetByKeyword(keyword string, skip, limit int) ([]Cardset, error)
    GetRandomCardset(count int) ([]Cardset, error)
    UpdateFavoriteCount(id string, liked bool) error
    UpdateVisitCount(id string) error
}
```

#### type Comment

Comment struct in model layer

```go
type Comment struct {
    ID         primitive.ObjectID   `bson:"_id"`
    OwnerID    primitive.ObjectID   `bson:"owner_id,omitempty"`
    CardID     primitive.ObjectID   `bson:"card_id,omitempty"`
    Content    string               `bson:"comment,omitempty"`
    LikedUsers []primitive.ObjectID `bson:"liked_users,omitempty"`
    Status     int                  `bson:"status,omitempty"`

    // CreateTime is the first time of adding the comment
    CreateTime int64 `bson:"create_time"`
    // LastUpdateTime is the last time of updating the comment
    LastUpdateTime int64 `bson:"update_time"`
}
```

#### type CommentInterface

```go
type CommentInterface interface {
    AddComment(comment Comment) (string, error)
    GetComments(cardID string) ([]Comment, bool, error)
    UpdateComment(comment Comment) error
    DeleteComment(comment Comment) (bool, error)
    GetCommentWithOwner(commentID, owner string) (Comment, error)
    UpdateLikedComment(comment, user string, liked bool) error
    IsCommentsLiked(card, user string) ([]bool, error)
}
```

#### type Model

```go
type Model interface {
    // Close will close database connection
    Close()
    // Abort will stop all statement and roll back when using transaction
    Abort()
    // VerifyCode
    VerifyCodeBlocking(mail string) (bool, error)
    SetVerifyCode(mail, code string) error
    GetVerifyCode(mail string) (string, error)
    // UserInterface contains all user functions in model layer
    UserInterface
    // CardsetInterface contains all cardset functions in model layer
    CardsetInterface
    // CardInterface contains all card functions in model layer
    CardInterface
    // CommentInterface contains all comment functions in model layer
    CommentInterface
    // RecordInterface contains all record functions in model layer
    RecordInterface
}
```

##### func GetModel

```go
func GetModel() Model
```

#### type QiniuUpload

```go
type QiniuUpload struct {
    User primitive.ObjectID `json:"user"`
    Url  string             `json:"url"`
}
```

#### type Record

Card struct in model layer

```go
type Record struct {
    ID        primitive.ObjectID `bson:"_id"`
    OwnerID   primitive.ObjectID `bson:"owner_id,omitempty"`
    CardsetID primitive.ObjectID `bson:"cardset_id,omitempty"`
    // CardID is ID of card that the record belongs to
    CardID     primitive.ObjectID `bson:"card_id,omitempty"`
    LastStudy  int64              `bson:"last_study,omitempty"`
    StudyTimes int                `bson:"study_times,omitempty"`
    // Status 0 means not finish study and 1 otherwise
    Status int `bson:"status,omitempty"`
}
```

#### type RecordInterface

```go
type RecordInterface interface {
    UpdateRecord(record Record) error
    GetRecords(cardsetID, ownerID primitive.ObjectID) ([]Record, error)
    ClearRecords(cardsetID, ownerID primitive.ObjectID) error
    GetLastStudyTime(cardsetID, ownerID primitive.ObjectID) int64
}
```

#### type User

User struct in model layer

```go
type User struct {
    ID       primitive.ObjectID `bson:"_id"`
    Mail     string             `bson:"mail,omitempty"`
    Username string             `bson:"username,omitempty"`
    Password string             `bson:"password,omitempty"`
    // CreateTime is time of signing up
    CreateTime int64 `bson:"create_time"`
    // Favorite card sets of user
    Favorite []primitive.ObjectID `bson:"favorite,omitempty"`
    // Avatar image url
    Avatar string `bson:"avatar,omitempty"`
}
```

#### type UserInterface

```go
type UserInterface interface {
    AddUser(user User) (string, error)
    GetUser(id string) (User, bool, error)
    GetUserByMail(mail string) (user User, err error)
    UpdateUser(user User) error
    UpdateFavorite(user, cardset string, liked bool) (bool, error)
    IsUserFavorite(user string, cardsetID primitive.ObjectID) bool
}
```

#### type dbTrait

```go
type dbTrait struct {
    db *mongo.Database
}
```

##### func getDBTx

```go
func getDBTx(ctx context.Context) dbTrait
```

#### type model

```go
type model struct {
    dbTrait
    ctx    context.Context
    abort  bool
    cancel context.CancelFunc
}
```

##### func \(\*model\) Abort

```go
func (m *model) Abort()
```

##### func \(\*model\) AddCard

```go
func (m *model) AddCard(card Card) (string, error)
```

AddCard inserts a new card into database

##### func \(\*model\) AddCards

```go
func (m *model) AddCards(card []Card) ([]string, error)
```

AddCards inserts new cards into database

##### func \(\*model\) AddCardset

```go
func (m *model) AddCardset(cardset Cardset) (string, error)
```

AddCardset inserts a new cardset into database

##### func \(\*model\) AddComment

```go
func (m *model) AddComment(comment Comment) (string, error)
```

AddComment inserts a new comment into database

##### func \(\*model\) AddUser

```go
func (m *model) AddUser(user User) (string, error)
```

AddUser inserts a new user into database and will return \`ErrExist\` when user with same mail exist in database

##### func \(\*model\) ClearRecords

```go
func (m *model) ClearRecords(cardsetID, ownerID primitive.ObjectID) error
```

ClearRecords of certain cardset and user

##### func \(\*model\) Close

```go
func (m *model) Close()
```

##### func \(\*model\) DeleteCard

```go
func (m *model) DeleteCard(card Card) (bool, error)
```

DeleteCard by id\, returns the card exist and error

##### func \(\*model\) DeleteCardset

```go
func (m *model) DeleteCardset(cardset Cardset) (bool, error)
```

DeleteCardset by id\, returns the cardset exist and error

##### func \(\*model\) DeleteComment

```go
func (m *model) DeleteComment(comment Comment) (bool, error)
```

DeleteComment by id\, returns the comment exist and error

##### func \(\*model\) GetCard

```go
func (m *model) GetCard(id string) (Card, bool, error)
```

GetCard by id\, returns the card struct\, whether the card exist and error

##### func \(\*model\) GetCardByIDList

```go
func (m *model) GetCardByIDList(ids []primitive.ObjectID) ([]Card, error)
```

GetCardByIDList by id\, returns the card struct\, whether the card exist and error

##### func \(\*model\) GetCardInCardset

```go
func (m *model) GetCardInCardset(cardset string) ([]Card, error)
```

GetCardInCardset returns the card struct\, whether the card exist and error

##### func \(\*model\) GetCardset

```go
func (m *model) GetCardset(id string) (Cardset, bool, error)
```

GetCardset by id\, returns the cardset struct\, whether the cardset exist and error

##### func \(\*model\) GetCardsetByIDList

```go
func (m *model) GetCardsetByIDList(ids []primitive.ObjectID) ([]Cardset, error)
```

GetCardsetByIDList returns the card struct\, whether the card exist and error\.

##### func \(\*model\) GetCardsetByKeyword

```go
func (m *model) GetCardsetByKeyword(keyword string, skip, limit int) ([]Cardset, error)
```

GetCardsetByKeyword returns cardsets which contains keyword in name or description\.

##### func \(\*model\) GetCardsetByOwner

```go
func (m *model) GetCardsetByOwner(owner string) ([]Cardset, error)
```

GetCardsetByOwner owner id\, returns the cardset list created by the user\.

##### func \(\*model\) GetCardsetWithOwner

```go
func (m *model) GetCardsetWithOwner(id, owner string) (Cardset, error)
```

GetCardsetWithOwner by id and owner id\, returns the cardset struct\, whether the cardset exists and error

##### func \(\*model\) GetCommentWithOwner

```go
func (m *model) GetCommentWithOwner(commentID, owner string) (Comment, error)
```

GetCommentWithOwner by comment id & owner id\, returns the comment struct\, whether the comment exists and error

##### func \(\*model\) GetComments

```go
func (m *model) GetComments(cardID string) ([]Comment, bool, error)
```

GetComments by id\, returns the comments slice\, whether the comment exist and error

##### func \(\*model\) GetCount

```go
func (m *model) GetCount(cardset string) (int, error)
```

GetCount of cards in certain cardset

##### func \(\*model\) GetLastStudyTime

```go
func (m *model) GetLastStudyTime(cardsetID, ownerID primitive.ObjectID) int64
```

GetLastStudyTime of certain cardset and user

##### func \(\*model\) GetRandomCardset

```go
func (m *model) GetRandomCardset(count int) ([]Cardset, error)
```

GetRandomCardset returns cardsets which contains keyword in name or description\.

##### func \(\*model\) GetRecord

```go
func (m *model) GetRecord(cardsetID, cardID, ownerID primitive.ObjectID) (Record, error)
```

##### func \(\*model\) GetRecords

```go
func (m *model) GetRecords(cardsetID, ownerID primitive.ObjectID) ([]Record, error)
```

GetRecords of certain cardset and user

##### func \(\*model\) GetUser

```go
func (m *model) GetUser(id string) (User, bool, error)
```

GetUser by id\, returns the user struct\, whether the user exist and error

##### func \(\*model\) GetUserByMail

```go
func (m *model) GetUserByMail(mail string) (user User, err error)
```

GetUserByMail will get user by mail

##### func \(\*model\) GetVerifyCode

```go
func (m *model) GetVerifyCode(mail string) (string, error)
```

GetVerifyCode returns verify code of \`mail\` and returns \`ErrNotFound\` when there is no code of mail\.

##### func \(\*model\) IsCommentsLiked

```go
func (m *model) IsCommentsLiked(card, user string) ([]bool, error)
```

IsCommentsLiked will return whether comments under the card is liked by

##### func \(\*model\) IsUserFavorite

```go
func (m *model) IsUserFavorite(user string, cardsetID primitive.ObjectID) bool
```

##### func \(\*model\) SetVerifyCode

```go
func (m *model) SetVerifyCode(mail, code string) error
```

SetVerifyCode sets verify code of mail\.

##### func \(\*model\) UpdateCard

```go
func (m *model) UpdateCard(card Card) error
```

UpdateCard updates card info in database\, empty fields will be ignore

##### func \(\*model\) UpdateCardset

```go
func (m *model) UpdateCardset(cardset Cardset) error
```

UpdateCardset updates cardset info in database\, empty fields will be ignore

##### func \(\*model\) UpdateComment

```go
func (m *model) UpdateComment(comment Comment) error
```

UpdateComment updates comment info in database\, empty fields will be ignore

##### func \(\*model\) UpdateFavorite

```go
func (m *model) UpdateFavorite(user, cardset string, liked bool) (bool, error)
```

UpdateFavorite insert a cardset\_id into user document\, and return whether it was modified

##### func \(\*model\) UpdateFavoriteCount

```go
func (m *model) UpdateFavoriteCount(id string, liked bool) error
```

UpdateFavoriteCount will increase favorite count when liked is false and decrease otherwise\.

##### func \(\*model\) UpdateLikedComment

```go
func (m *model) UpdateLikedComment(comment, user string, liked bool) error
```

UpdateLikedComment by id\. If the comment is not liked by user\, add the user to liked\_users list; if the coment is liked by the user\, cancel it\.

##### func \(\*model\) UpdateRecord

```go
func (m *model) UpdateRecord(record Record) error
```

UpdateRecord inserts a new study record into database when it's not exist and update \`last\_study\` and \`study\_times\` otherwise\. Only record in different natural day \(UTC\+8\) will increase \`study\_times\`\.

##### func \(\*model\) UpdateUser

```go
func (m *model) UpdateUser(user User) error
```

UpdateUser updates user info in database\, empty fields will be ignore

##### func \(\*model\) UpdateVisitCount

```go
func (m *model) UpdateVisitCount(id string) error
```

UpdateVisitCount will increase visit count\.

##### func \(\*model\) VerifyCodeBlocking

```go
func (m *model) VerifyCodeBlocking(mail string) (bool, error)
```

VerifyCodeBlocking will check the duration after last mail and return true if the duration is too short\.

##### func \(\*model\) cardC

```go
func (m *model) cardC() *mongo.Collection
```

##### func \(\*model\) cardsetC

```go
func (m *model) cardsetC() *mongo.Collection
```

##### func \(\*model\) commentC

```go
func (m *model) commentC() *mongo.Collection
```

##### func \(\*model\) recordC

```go
func (m *model) recordC() *mongo.Collection
```

##### func \(\*model\) userC

```go
func (m *model) userC() *mongo.Collection
```

#### type objArray

```go
type objArray []interface{}
```



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


### 1.6.2. 后端的 API 接口算法设计

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

```go
import "github.com/woolen-sheep/Flicker-BE/controller"
```

#### Index

- [func ClearRecords(c echo.Context) error](<#func-clearrecords>)
- [func DeleteCard(c echo.Context) error](<#func-deletecard>)
- [func DeleteCardset(c echo.Context) error](<#func-deletecardset>)
- [func DeleteComment(c echo.Context) error](<#func-deletecomment>)
- [func GetCard(c echo.Context) error](<#func-getcard>)
- [func GetCards(c echo.Context) error](<#func-getcards>)
- [func GetCardset(c echo.Context) error](<#func-getcardset>)
- [func GetComments(c echo.Context) error](<#func-getcomments>)
- [func GetCreated(c echo.Context) error](<#func-getcreated>)
- [func GetFavorite(c echo.Context) error](<#func-getfavorite>)
- [func GetQiniuUploadToken(c echo.Context) error](<#func-getqiniuuploadtoken>)
- [func GetRandomCardsets(c echo.Context) error](<#func-getrandomcardsets>)
- [func GetRecords(c echo.Context) error](<#func-getrecords>)
- [func GetUser(c echo.Context) error](<#func-getuser>)
- [func HTTPErrorHandler(err error, c echo.Context)](<#func-httperrorhandler>)
- [func Login(c echo.Context) error](<#func-login>)
- [func NewCard(c echo.Context) error](<#func-newcard>)
- [func NewCards(c echo.Context) error](<#func-newcards>)
- [func NewCardset(c echo.Context) error](<#func-newcardset>)
- [func NewComment(c echo.Context) error](<#func-newcomment>)
- [func SearchCardsets(c echo.Context) error](<#func-searchcardsets>)
- [func SendVerifyCode(c echo.Context) error](<#func-sendverifycode>)
- [func SignUp(c echo.Context) error](<#func-signup>)
- [func UpdateCard(c echo.Context) error](<#func-updatecard>)
- [func UpdateCardset(c echo.Context) error](<#func-updatecardset>)
- [func UpdateFavorite(c echo.Context) error](<#func-updatefavorite>)
- [func UpdateLikedComment(c echo.Context) error](<#func-updatelikedcomment>)
- [func UpdateRecord(c echo.Context) error](<#func-updaterecord>)
- [func UpdateUser(c echo.Context) error](<#func-updateuser>)


#### func ClearRecords

```go
func ClearRecords(c echo.Context) error
```

#### func DeleteCard

```go
func DeleteCard(c echo.Context) error
```

DeleteCard will accept card ID and delete the exact card\.

#### func DeleteCardset

```go
func DeleteCardset(c echo.Context) error
```

DeleteCardset will accept cardset ID and delete the exact cardset\.

#### func DeleteComment

```go
func DeleteComment(c echo.Context) error
```

DeleteComment will accept card ID & comment ID and delete the exact comment\.

#### func GetCard

```go
func GetCard(c echo.Context) error
```

GetCard will accept card ID and return card info\.

#### func GetCards

```go
func GetCards(c echo.Context) error
```

GetCards will accept a card ID list and return a card info list\.

#### func GetCardset

```go
func GetCardset(c echo.Context) error
```

GetCardset will accept cardset ID and return cardset info\.

#### func GetComments

```go
func GetComments(c echo.Context) error
```

GetComments will accept card ID and return comments of the certain card\.

#### func GetCreated

```go
func GetCreated(c echo.Context) error
```

GetCreated will return cardsets created by current user\.

#### func GetFavorite

```go
func GetFavorite(c echo.Context) error
```

GetFavorite will return favorite cardsets of current user\.

#### func GetQiniuUploadToken

```go
func GetQiniuUploadToken(c echo.Context) error
```

#### func GetRandomCardsets

```go
func GetRandomCardsets(c echo.Context) error
```

GetRandomCardsets will return a list of random public cardsets\.

#### func GetRecords

```go
func GetRecords(c echo.Context) error
```

GetRecords will accept cardset ID and return all study record of current user\.

#### func GetUser

```go
func GetUser(c echo.Context) error
```

GetUser will accept user ID and return user info\. If param \`user\_id\` is empty\, will try to use user ID in JWT\.

#### func HTTPErrorHandler

```go
func HTTPErrorHandler(err error, c echo.Context)
```

HTTPErrorHandler will handle all errors and convert errors to certain format

#### func Login

```go
func Login(c echo.Context) error
```

Login will check password and return a JWT token\.

#### func NewCard

```go
func NewCard(c echo.Context) error
```

NewCard will add a new card\.

#### func NewCards

```go
func NewCards(c echo.Context) error
```

NewCards will add new cards\.

#### func NewCardset

```go
func NewCardset(c echo.Context) error
```

NewCardset will add a new cardset\.

#### func NewComment

```go
func NewComment(c echo.Context) error
```

NewComment will append a comment to a certain card\.

#### func SearchCardsets

```go
func SearchCardsets(c echo.Context) error
```

SearchCardsets will accept query param \`keyword\` and search in title and description of cardsets and return a cardset array\.

#### func SendVerifyCode

```go
func SendVerifyCode(c echo.Context) error
```

SendVerifyCode will shed a verify code to the given email address\. Two emails to the same address SHOULD have a duration of one minute at least\. Verify code will have a expire duration of 15 minutes\.

#### func SignUp

```go
func SignUp(c echo.Context) error
```

SignUp will check mail verify code and add a new user\.

#### func UpdateCard

```go
func UpdateCard(c echo.Context) error
```

UpdateCard will update card info of current card\. Empty fields will be ignored\.

#### func UpdateCardset

```go
func UpdateCardset(c echo.Context) error
```

UpdateCardset will update cardset info of current cardset\. Empty fields will be ignored\.

#### func UpdateFavorite

```go
func UpdateFavorite(c echo.Context) error
```

UpdateFavorite will add a cardset into current user collection

#### func UpdateLikedComment

```go
func UpdateLikedComment(c echo.Context) error
```

#### func UpdateRecord

```go
func UpdateRecord(c echo.Context) error
```

UpdateRecord will accept card ID and update study record

#### func UpdateUser

```go
func UpdateUser(c echo.Context) error
```

UpdateUser will update user info of current user\. Empty fields will be ignored\.



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


## 1.7. 数据管理说明

本项目考虑到可拓展性以及分布式部署的维护性，选用了MongoDB作为数据库。golang使用MongoDB官方维护的ORM引擎mongo-driver与数据库进行交互。

### 1.7.1. 使用数据库概述

1. MongoDB

   MongoDB是一个基于分布式文件存储的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。
   MongoDB是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。它支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。Mongo最大的特点是它支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。

2. mongo-driver

   mongo-driver是MongoDB官方编写发布并维护的golang MongoDB的ORM引擎。由于是官方维护的，其可靠性非常高，同时在golang并发特性的支持下拥有很高的性能，并且在官方的积极维护下总是能使用到最新的特性，是当下使用率最高的MongoDB ORM库之一。
